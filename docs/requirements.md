# 眼鏡店顧客管理システム 要件定義書

**バージョン**: 1.0.0  
**最終更新日**: 2025-08-05  
**ステータス**: ドラフト  

## 1. プロジェクト概要

### 1.1 目的と背景

このプロジェクトは、40店舗を展開する眼鏡チェーン店において、紙ベースの顧客カルテ管理から完全電子化への移行を実現し、全店舗でのリアルタイムな顧客情報共有と、受注時売上計上による正確な経営管理を可能にすることを目的としています。現在の課題である売上計上タイミングの問題（お渡し時計上による月跨ぎ問題）を解決し、在庫管理の矛盾を解消します。

### 1.2 ターゲットユーザー

- **店舗スタッフ（各店舗2名以上）**: 日々の接客・販売業務で顧客情報の参照・更新を行う
- **店長・店舗管理者（40店舗）**: 店舗の売上分析、顧客動向の把握、スタッフ管理を行う
- **本部スタッフ**: 全店舗のデータ管理・分析、原価管理、マーケティング戦略立案を行う

### 1.3 核となる機能と価値

以下は、プロジェクトの本質的価値を提供するために「絶対に必要」な機能です。各機能は「この機能がないとプロジェクトの目的達成が不可能になる」という基準で厳選されています。

- **受注時売上計上機能**: 契約成立時点での売上計上により正確な月次売上把握を実現 - *この機能がないと在庫管理の矛盾が継続し、正確な経営判断ができない*
- **全店舗リアルタイム顧客情報共有**: どの店舗でも顧客の購入履歴・度数データを即座に確認 - *この機能がないと他店舗利用時に適切なサービスが提供できない*
- **タブレット対応の電子カルテ**: 手書きメモ機能付きで接客時の持ち運び可能 - *この機能がないと現場スタッフの受け入れが困難になる*
- **階層別アクセス権限管理**: 原価情報の本部限定閲覧など役割に応じた情報管理 - *この機能がないと機密情報の漏洩リスクが発生する*
- **顧客データ検索・分析機能**: 過去の購入履歴や度数変化の時系列確認 - *この機能がないとマーケティング活用や適切な提案ができない*
- **在庫管理機能（個品・数量管理）**: フレームの個品管理とコンタクト等の数量管理による正確な在庫把握 - *この機能がないと商品の所在が不明になり、適切な販売ができない*

## 2. 画面一覧

このアプリケーションは以下の画面要素と実際のページで構成されます。各ページのモックアップは作成後に詳細化されます。

### 2.1 画面要素一覧

以下は機能的に必要な全ての画面要素です。これらは必ずしも独立したページとして実装されるわけではありません。

| 画面要素名 | 目的 | 実現する核心的価値 |
|----------|------|----------------|
| ログイン要素 | ユーザー認証 | セキュリティ確保・権限管理 |
| 顧客検索要素 | 顧客情報の高速検索 | 接客時間短縮・サービス向上 |
| 顧客基本情報要素 | 顧客の個人情報管理 | 顧客データの一元管理 |
| 視力・度数データ要素 | 検査結果の記録・履歴管理 | 適切な商品提案・健康管理支援 |
| 購入履歴要素 | 過去の購入商品・金額表示 | リピート提案・顧客満足度向上 |
| 受注入力要素 | 新規受注の登録 | 受注時売上計上・在庫管理改善 |
| 売掛管理要素 | 一部入金・残金管理 | 正確な債権管理 |
| 手書きメモ要素 | 自由記述の顧客メモ | 現場ニーズ対応・詳細情報記録 |
| 発注データ出力要素 | メガネット/CLIOS連携用データ作成 | 既存システムとの連携 |
| 売上分析要素 | 店舗別・期間別売上表示 | 経営判断支援 |
| 顧客分析要素 | 購買パターン・属性分析 | マーケティング戦略立案 |
| 原価管理要素 | 商品原価の表示・管理 | 利益管理（本部限定） |
| ユーザー管理要素 | スタッフアカウント管理 | アクセス制御・セキュリティ |
| フレーム在庫管理要素 | 個品番号による在庫追跡 | 個別商品の所在管理 |
| 数量在庫管理要素 | コンタクト等の数量管理 | 適正在庫の維持 |
| レジ開設要素 | 営業開始時のレジ金設定 | 釣銭準備金の記録 |
| 売上集計要素 | 支払方法別の売上集計 | 日次売上の正確な把握 |
| レジ精算要素 | 現金実査・システム照合 | レジ締め処理 |
| 差異管理要素 | 過不足金の記録・原因記載 | 金銭管理の透明性確保 |

### 2.2 ページ構成計画

上記の画面要素を、ユーザー体験とナビゲーション効率を最適化するために以下のように統合・構成します。

#### 2.2.1 公開ページ

| ID | ページ名 | 主な目的 | 含まれる画面要素 | 優先度 | モックアップ | 実装状況 |
|----|---------|---------|----------------|-------|------------|---------| 
| P-001 | ログインページ | ユーザー認証 | ログイン要素 | 高 | [login.html](/mockups/login.html) | 未着手 |

#### 2.2.2 店舗スタッフページ（要認証）

| ID | ページ名 | 主な目的 | 含まれる画面要素 | 優先度 | モックアップ | 実装状況 |
|----|---------|---------|----------------|-------|------------|---------| 
| S-001 | 顧客検索ページ | 顧客情報の検索 | 顧客検索要素 | 高 | [customer-search.html](/mockups/customer-search.html) | 未着手 |
| S-002 | 顧客詳細ページ | 顧客情報の閲覧・編集 | 顧客基本情報要素、視力・度数データ要素、購入履歴要素、手書きメモ要素、画像管理要素 | 高 | [customer-detail.html](/mockups/customer-detail.html) | 完了 |
| S-003 | 受注入力ページ | 新規受注登録 | 受注入力要素、売掛管理要素、発注データ出力要素 | 高 | [order-entry.html](/mockups/order-entry.html) | 未着手 |
| S-004 | 受注一覧ページ | 受注状況確認 | 受注ステータス管理、納品予定確認 | 中 | [order-list.html](/mockups/order-list.html) | 未着手 |
| S-005 | 在庫管理ページ | 在庫状況確認・管理 | フレーム在庫管理要素、数量在庫管理要素 | 高 | [inventory.html](/mockups/inventory.html) | 未着手 |
| S-006 | レジ精算ページ | 日次レジ開設・精算処理 | レジ開設要素、売上集計要素、レジ精算要素、差異管理要素 | 高 | [cash-register.html](/mockups/cash-register.html) | 完了 |

#### 2.2.3 店長・管理者ページ（要店長権限）

| ID | ページ名 | 主な目的 | 含まれる画面要素 | 優先度 | モックアップ | 実装状況 |
|----|---------|---------|----------------|-------|------------|---------| 
| M-001 | 店舗ダッシュボード | 店舗業績確認 | 売上分析要素（店舗限定）、顧客分析要素（店舗限定） | 中 | [store-dashboard.html](/mockups/store-dashboard.html) | 未着手 |

#### 2.2.4 本部ページ（要本部権限）

| ID | ページ名 | 主な目的 | 含まれる画面要素 | 優先度 | モックアップ | 実装状況 |
|----|---------|---------|----------------|-------|------------|---------| 
| H-001 | 本部ダッシュボード | 全店舗統括管理 | 売上分析要素（全店舗）、顧客分析要素（全店舗）、原価管理要素 | 高 | [hq-dashboard.html](/mockups/hq-dashboard.html) | 未着手 |
| H-002 | ユーザー管理ページ | スタッフ管理 | ユーザー管理要素 | 中 | [user-management.html](/mockups/user-management.html) | 未着手 |

### 2.3 主要ルート定義

#### 公開ルート
| パス | ページID | 説明 |
|------|---------|------|
| `/login` | P-001 | ログイン |

#### 店舗スタッフルート（要認証）
| パス | ページID | 説明 |
|------|---------|------|
| `/` | S-001 | 顧客検索（ホーム） |
| `/customers/:id` | S-002 | 顧客詳細 |
| `/orders/new` | S-003 | 受注入力 |
| `/orders` | S-004 | 受注一覧 |
| `/inventory` | S-005 | 在庫管理 |
| `/cash-register` | S-006 | レジ精算 |

#### 店長・管理者ルート（要店長権限）
| パス | ページID | 説明 |
|------|---------|------|
| `/manager/dashboard` | M-001 | 店舗ダッシュボード |

#### 本部ルート（要本部権限）
| パス | ページID | 説明 |
|------|---------|------|
| `/hq/dashboard` | H-001 | 本部ダッシュボード |
| `/hq/users` | H-002 | ユーザー管理 |

### 2.4 特殊な画面遷移

- 顧客検索結果から顧客詳細ページへの遷移時、最新の受注情報を自動表示
- 受注入力完了後、発注データ出力画面への自動遷移オプション

### 2.5 共通レイアウト構成

#### レイアウトパターン
- **認証前**: ヘッダーのみ（ロゴ・ログインリンク）
- **店舗スタッフ用**: ヘッダー + 店舗メニュー
- **本部スタッフ用**: ヘッダー + 管理メニュー

#### ヘッダー要素

##### 認証後ヘッダー
- アプリケーションロゴ
- 現在の店舗名表示
- ユーザー名・権限表示
- ログアウトボタン

#### サイドメニュー

##### 店舗スタッフ用メニュー
- 顧客検索
- 受注入力
- 受注一覧

##### 本部用メニュー  
- 本部ダッシュボード
- ユーザー管理
- 全店舗売上分析
- マスタ管理

## 3. ページ詳細

### 3.1 公開ページ

#### 3.1.1 ログインページ (P-001)

**ページ概要**: システムへのログイン認証を行う

**含まれる画面要素**:
- ユーザーID入力フィールド
- パスワード入力フィールド
- 店舗選択ドロップダウン
- ログインボタン

**状態と動作**:
- 初期状態: 全フィールド空欄
- ログイン失敗: エラーメッセージ表示
- ログイン成功: 権限に応じたホーム画面へ遷移

### 3.2 店舗スタッフページ

#### 3.2.1 顧客詳細ページ (S-002)
**モックアップ**: [customer-detail.html](/mockups/customer-detail.html)

**ページ概要**: 顧客の全情報を統合表示し、編集可能にする

**含まれる画面要素**:
- 顧客基本情報（氏名、連絡先、住所等）
- 視力・度数データ（時系列表示）
  - 右眼・左眼の度数（S:球面度数、C:円柱度数、AX:軸）
  - 瞳孔間距離（PD）
  - 矯正視力
  - 測定日
- 購入履歴一覧
  - 購入日、商品名、金額
  - 使用レンズ・フレーム詳細
- 手書きメモエリア（タブレット対応）
- 画像管理機能
  - カメラ撮影・ファイルアップロード
  - 画像への注釈機能（レイヤー保存）

**状態と動作**:
- タブ切り替えによる情報整理（基本情報/視力・度数/購入履歴/メモ・画像）
- 最新の度数データを優先表示、過去履歴は折りたたみ可能
- 画像クリックで注釈モーダル表示
- 注釈データは画像とは別レイヤーで保存

**データとAPI**:
- `GET /api/customers/:id` → 顧客詳細取得
- `PUT /api/customers/:id` → 顧客情報更新
- `POST /api/customers/:id/memos` → メモ追加
- `POST /api/customers/:id/images` → 画像アップロード
- `GET /api/customers/:id/images/:imageId/annotations` → 画像注釈取得
- `PUT /api/customers/:id/images/:imageId/annotations` → 画像注釈更新

#### 3.2.2 受注入力ページ (S-003)

**ページ概要**: 新規受注の登録と売上計上処理

**含まれる画面要素**:
- 商品選択（フレーム、レンズ）
- 度数入力（最新データ自動反映）
- 金額計算
- 入金情報（全額/一部入金選択）
- 納期設定
- 発注データ出力ボタン

**重要な処理**:
- 受注確定時点で売上計上
- 一部入金の場合は売掛金として管理
- メガネット/CLIOS用のCSV出力機能
- フレーム選択時は個品番号を指定

#### 3.2.3 在庫管理ページ (S-005)

**ページ概要**: フレームの個品管理とコンタクト等の数量管理を統合管理

**含まれる画面要素**:
- フレーム在庫一覧（個品番号検索）
  - 個品番号
  - 商品名・型番
  - 仕入日
  - 在庫状態（在庫/販売済/取り置き）
  - 店舗間移動履歴
- コンタクト・その他商品在庫（数量管理）
  - 商品名
  - 現在庫数
  - 発注点
  - 店舗別在庫数
- 在庫検索機能
- 棚卸し機能

**データとAPI**:
- `GET /api/inventory/frames` → フレーム在庫一覧
- `GET /api/inventory/frames/:serialNumber` → 個品情報取得
- `GET /api/inventory/products` → 数量管理商品一覧
- `PUT /api/inventory/frames/:serialNumber/status` → フレーム状態更新

#### 3.2.4 レジ精算ページ (S-006)
**モックアップ**: [cash-register.html](/mockups/cash-register.html)

**ページ概要**: 店舗の日次レジ開設・精算処理を管理

**含まれる画面要素**:
- レジ開設処理
  - 営業開始時刻の記録
  - 釣銭準備金の設定（紙幣・硬貨別）
  - 前日繰越金の確認
- 売上集計表示
  - 現金売上
  - クレジットカード売上
  - 電子マネー売上
  - 売掛金回収
- レジ精算処理
  - 現金実査入力（紙幣・硬貨別）
  - システム計上額との照合
  - 過不足金の自動計算
  - 差異理由の記録
- 精算レポート
  - 日次精算書の出力
  - 店長承認機能

**状態と動作**:
- 未開設: レジ開設ボタンのみ表示
- 営業中: 売上リアルタイム更新、精算ボタン表示
- 精算済: 当日の精算結果表示（読み取り専用）
- エラー状態: 差異発生時の警告表示

**データとAPI**:
- `POST /api/cash-register/open` → レジ開設
- `GET /api/cash-register/status` → レジ状態取得
- `GET /api/cash-register/sales-summary` → 売上集計取得
- `POST /api/cash-register/close` → レジ精算実行
- `GET /api/cash-register/report/:date` → 精算レポート取得

## 4. データモデル概要

### 4.1 主要エンティティ

| エンティティ | 主な属性 | 関連エンティティ | 備考 |
|------------|----------|----------------|------|
| Customer（顧客） | ID、氏名、連絡先、住所、生年月日 | Order、Prescription | 全店舗共通 |
| Prescription（処方箋） | ID、顧客ID、測定日、右眼度数、左眼度数、PD | Customer | 時系列管理 |
| Order（受注） | ID、顧客ID、受注日、商品情報、金額、入金状況 | Customer、Payment | 受注時売上計上 |
| Payment（入金） | ID、受注ID、入金日、入金額 | Order | 売掛管理用 |
| Product（商品） | ID、商品名、種別、原価、販売価格 | Order、Frame、StockItem | 原価は権限制御 |
| Frame（フレーム） | 個品番号、商品ID、仕入日、状態、現在店舗ID | Product、Store、Order | 個品管理用 |
| StockItem（在庫商品） | ID、商品ID、店舗ID、在庫数、発注点 | Product、Store | 数量管理用 |
| User（ユーザー） | ID、氏名、店舗ID、権限レベル | Store | スタッフ管理 |
| Store（店舗） | ID、店舗名、住所 | User、Order、Frame、StockItem | 40店舗管理 |
| CashRegister（レジ） | ID、店舗ID、営業日、開設時刻、精算時刻、準備金 | Store、CashTransaction | 日次管理 |
| CashTransaction（現金取引） | ID、レジID、取引種別、金額、支払方法 | CashRegister、Order | 売上・入出金記録 |

#### 3.2.7 商品マスタ管理ページ (M-001)

**ページ概要**: 商品情報の新規登録・編集・削除を行う管理画面

**含まれる画面要素**:
- 商品一覧表（検索・フィルタ機能付き）
- 商品新規登録フォーム
- 商品情報編集フォーム
- 商品コード自動生成機能
- 商品カテゴリ別表示（フレーム、レンズ、コンタクト、補聴器、アクセサリー）

**重要な処理**:
- 商品コード重複チェック
- 価格変更履歴記録
- 商品削除時の受注データ整合性チェック

**データとAPI**:
- `GET /api/products` → 商品一覧取得
- `POST /api/products` → 商品新規作成
- `PUT /api/products/:id` → 商品情報更新
- `DELETE /api/products/:id` → 商品削除

#### 3.2.8 ユーザー管理ページ (M-002)

**ページ概要**: システムユーザー（スタッフ・店長・本部）の登録・権限管理を行う

**含まれる画面要素**:
- ユーザー一覧表（店舗別表示）
- ユーザー新規登録フォーム
- パスワードリセット機能
- 権限設定（スタッフ、店長、管理者）
- 所属店舗変更機能

**重要な処理**:
- パスワードハッシュ化
- ユーザーコード重複チェック
- 権限変更時の操作ログ記録

**データとAPI**:
- `GET /api/users` → ユーザー一覧取得
- `POST /api/users` → ユーザー新規作成
- `PUT /api/users/:id` → ユーザー情報更新
- `POST /api/users/:id/reset-password` → パスワードリセット

#### 3.2.9 店舗マスタ管理ページ (M-003)

**ページ概要**: 店舗情報の登録・編集・新店舗追加を行う管理画面

**含まれる画面要素**:
- 店舗一覧表（地域別表示）
- 店舗新規登録フォーム
- 店舗情報編集フォーム
- 店舗コード自動生成機能
- 店舗ステータス管理（営業中、休業中、閉店）

**重要な処理**:
- 店舗コード重複チェック
- 店舗削除時の関連データ整合性チェック
- 店舗間データ移行機能

**データとAPI**:
- `GET /api/stores` → 店舗一覧取得
- `POST /api/stores` → 店舗新規作成
- `PUT /api/stores/:id` → 店舗情報更新
- `DELETE /api/stores/:id` → 店舗削除

## 5. 特記すべき非機能要件

- **タブレット最適化**: 接客時の持ち運びを考慮し、タブレット端末での操作性を最優先で設計
- **レスポンスタイム**: 顧客検索は全店舗データから3秒以内に結果表示
- **同時アクセス**: 祝日の100人以上の来店に対応できる同時接続性能
- **データ同期**: 各店舗の入力データは30秒以内に全店舗で参照可能
- **外部システム連携**: メガネット/CLIOS用のデータ出力フォーマット対応

## 6. 開発計画とマイルストーン

| フェーズ | 内容 | 期間 | ステータス |
|---------|------|------|----------|
| フェーズ1 | 要件定義・基本設計 | 2週間 | 進行中 |
| フェーズ2 | 詳細設計・モックアップ作成 | 3週間 | 未着手 |
| フェーズ3 | コア機能開発（顧客管理・受注） | 6週間 | 未着手 |
| フェーズ4 | 分析機能・外部連携開発 | 4週間 | 未着手 |
| フェーズ5 | テスト・移行準備 | 3週間 | 未着手 |
| フェーズ6 | 段階的展開（パイロット店舗→全店舗） | 4週間 | 未着手 |

## 7. 添付資料

- 現行システム（メガネット/CLIOS）の仕様書: [後日提供予定]
- 店舗一覧・規模情報: [後日提供予定]
- 移行対象データ量見積: [調査予定]